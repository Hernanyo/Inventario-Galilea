{% extends "base.html" %}

{% block title %}
  {% if object %}
    Editar {{ view.crud_config.verbose_name }}
  {% else %}
    Nuevo {{ view.crud_config.verbose_name }}
  {% endif %}
{% endblock %}

{% block content %}
<h1 class="h3 mb-4">
  {% if object %}
    Editar {{ view.crud_config.verbose_name }} #{{ object.pk }}
  {% else %}
    Nuevo {{ view.crud_config.verbose_name }}
  {% endif %}
</h1>

<div class="container-fluid">
  <div class="row g-4">
    <!-- Columna izquierda: Formulario -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            {{ form.as_p }}

            {% if view.crud_config.model_name == "equipo" %}
              <hr class="my-4">
              <h5 class="mb-2">Atributos del equipo</h5>
              <p class="text-muted small">Se generan a partir del tipo de equipo seleccionado.</p>

              <div id="attrs-container" class="vstack gap-2"></div>

              <script>
                (function(){
                  const tipoSelect = document.getElementById('id_id_tipo_equipo');
                  const container  = document.getElementById('attrs-container');

                  async function loadAttrs(tipoId) {
                    container.innerHTML = '';
                    if (!tipoId) return;
                    const res = await fetch("{% url 'productos:api_atributos_por_tipo' %}?tipo_id=" + encodeURIComponent(tipoId));
                    const data = await res.json();
                    (data.items || []).forEach(item => {
                      const wrap = document.createElement('div');
                      wrap.className = 'row g-2 align-items-center';

                      // etiqueta
                      const col1 = document.createElement('div');
                      col1.className = 'col-12 col-md-4';
                      col1.innerHTML = `<label class="form-label mb-1">${item.atributo}</label>`;
                      wrap.appendChild(col1);

                      // input valor
                      const col2 = document.createElement('div');
                      col2.className = 'col-12 col-md-8';
                      const defVal = item.valor || '';
                      col2.innerHTML = `
                        <input type="text" class="form-control"
                              name="attr_${item.id_atributo_equipo}"
                              placeholder="Valor"
                              value="${defVal.replaceAll('"','&quot;')}">
                      `;
                      wrap.appendChild(col2);

                      container.appendChild(wrap);
                    });
                  }

                  // Carga inicial (por si al editar ya hay tipo seleccionado)
                  if (tipoSelect && tipoSelect.value) {
                    loadAttrs(tipoSelect.value);
                  }
                  // Cambio de tipo â†’ recarga atributos
                  if (tipoSelect) {
                    tipoSelect.addEventListener('change', ev => loadAttrs(ev.target.value));
                  }
                })();
              </script>
            {% endif %}

              <div class="mb-2">
                {% if ultima_etiqueta %}
                  <p class="text-muted small">
                    Ãšltima etiqueta usada: <strong>{{ ultima_etiqueta }}</strong>
                  </p>
                {% endif %}
              </div>
              <div class="mb-3">
                {% if object and object.qr_code %}
                  <a href="{% url 'productos:equipos_qr' object.pk %}" class="btn btn-primary btn-sm">Ver QR</a>
                {% else %}
                  <span class="text-muted small">ðŸ•“ QR a la espera de creaciÃ³n</span>
                {% endif %}
              </div>

            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-primary">Guardar</button>
              <a class="btn btn-outline-secondary" href="{% url 'productos:'|add:view.crud_config.slug|add:'_list' %}">Cancelar</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Columna derecha: Panel lateral -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          {% if view.crud_config.model_name == "equipo" %}
            <h2 class="h6 fw-semibold mb-3">Ãšltimos 5 equipos</h2>
            {% if ultimos_equipos %}
              <ul class="small mb-0">
                {% for eq in ultimos_equipos %}
                  <li>{{ eq.nombre_equipo }} <span class="text-muted">({{ eq.etiqueta }})</span></li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-0">No hay equipos aÃºn.</p>
            {% endif %}

          {% elif view.crud_config.model_name == "mantencion" %}
            <h2 class="h6 fw-semibold mb-3">Ãšltimas mantenciones</h2>
            {% if side_items %}
              <ul class="small mb-0">
                {% for m in side_items %}
                  <li>M#{{ m.id_mantencion }} â€” {{ m.id_equipo|default:"Equipo s/i" }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-0">No hay mantenciones aÃºn.</p>
            {% endif %}

          {% elif view.crud_config.model_name == "empresa" %}
            <h2 class="h6 fw-semibold mb-3">Ãšltimas empresas</h2>
            {% if side_items %}
              <ul class="small mb-0">
                {% for e in side_items %}
                  <li>{{ e.nombre_empresa }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-0">No hay empresas aÃºn.</p>
            {% endif %}

          {% elif view.crud_config.model_name == "empleado" %}
            <h2 class="h6 fw-semibold mb-3">{{ side_title|default:"Ãšltimos empleados" }}</h2>
            {% if side_items %}
              <ul class="small mb-0">
                {% for e in side_items %}
                  <li>
                    {{ e.nombre }} {{ e.apellido_paterno }}{% if e.apellido_materno %} {{ e.apellido_materno }}{% endif %}
                    {% if e.id_empresa %}<span class="text-muted"> Â· {{ e.id_empresa.nombre_empresa }}</span>{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-0">No hay empleados aÃºn.</p>
            {% endif %}

          {# === NUEVOS BLOQUES === #}
          {% elif view.crud_config.model_name == "marca" %}
            <h2 class="h6 fw-semibold mb-3">{{ side_title|default:"Ãšltimas marcas" }}</h2>
            {% if side_items %}
              <ul class="small mb-0">
                {% for m in side_items %}
                  <li>{{ m.nombre_marca }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-0">No hay marcas aÃºn.</p>
            {% endif %}

          {% elif view.crud_config.model_name == "proveedor" %}
            <h2 class="h6 fw-semibold mb-3">{{ side_title|default:"Ãšltimos proveedores" }}</h2>
            {% if side_items %}
              <ul class="small mb-0">
                {% for p in side_items %}
                  <li>{{ p.nombre_proveedor }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-0">No hay proveedores aÃºn.</p>
            {% endif %}

          {% elif view.crud_config.model_name == "factura" %}
            <h2 class="h6 fw-semibold mb-3">{{ side_title|default:"Ãšltimas facturas" }}</h2>
            {% if side_items %}
              <ul class="small mb-0">
                {% for f in side_items %}
                  <li>
                    Factura #{{ f.id_factura }}
                    {% if f.fecha_emision %}<span class="text-muted"> Â· {{ f.fecha_emision }}</span>{% endif %}
                    {% if f.id_proveedor %}<span class="text-muted"> Â· {{ f.id_proveedor.nombre_proveedor }}</span>{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-0">No hay facturas aÃºn.</p>
            {% endif %}

          {% else %}
            <h2 class="h6 fw-semibold mb-3">Resumen</h2>
            <p class="text-muted small mb-0">Sin datos recientes.</p>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
