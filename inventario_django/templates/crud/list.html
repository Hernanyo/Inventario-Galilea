{% extends "base.html" %}
{% load object_extras %}

{% block title %}{{ view.crud_config.verbose_plural }}{% endblock %}

{% block content %}

<h1 class="text-2xl font-semibold">
  Listado de {{ view.crud_config.verbose_plural }}
  {% if equipo %}
    <span class="badge bg-secondary ms-2">Equipo {{ equipo.id_equipo }} · {{ equipo.nombre_equipo }}</span>
  {% endif %}
</h1>

<div class="flex items-center justify-between mb-4">
  <div class="flex items-center gap-2 w-full justify-end">
    {% if view.crud_config.can_create %}
      <a class="btn btn-primary btn-sm"
        href="{% url 'productos:'|add:view.crud_config.slug|add:'_create' %}">
        Nuevo {{ view.crud_config.verbose_name }}
      </a>
    {% endif %}

    <a class="btn btn-outline btn-sm"
       href="{% url 'productos:'|add:view.crud_config.slug|add:'_csv' %}?q={{ q }}">
      Exportar CSV
    </a>

    {% if view.crud_config.model_name == 'factura' %}
      <a class="btn btn-secondary btn-sm"
         href="{% url 'productos:detallefacturas_list' %}">
        Detalle Facturas
      </a>
    {% endif %}

    {% if view.crud_config.model_name == 'empresa' %}
      <a class="btn btn-secondary btn-sm"
         href="{% url 'productos:departamentos_list' %}">
        Departamentos
      </a>
    {% endif %}

    {% if view.crud_config.model_name == 'equipo' %}
      <a class="btn btn-secondary btn-sm" href="{% url 'productos:tipoequipos_list' %}">Tipos de Equipos</a>
      <a class="btn btn-secondary btn-sm" href="{% url 'productos:atributosequipos_list' %}">Atributos de Equipos</a>
      <a class="btn btn-secondary btn-sm" href="{% url 'productos:estadoequipos_list' %}">Estados de Equipos</a>
      <a href="{% url 'productos:historial_equipos_list' %}" class="btn btn-info">Historial de Equipos</a>
    {% endif %}

    {% if view.crud_config.model_name == 'mantencion' %}
      <a class="btn btn-secondary btn-sm" href="{% url 'productos:estadomantencions_list' %}">Estados de Mantenciones</a>
    {% endif %}

    <a class="btn btn-error btn-sm ml-2" href="javascript:history.back()">⬅ Atrás</a>

    <span id="current_datetime" class="ml-4 font-semibold text-gray-700 text-lg"></span>
  </div>
</div>

<form method="get" class="mb-3 flex gap-2">
  <input class="input input-bordered w-full max-w-md"
         type="search" name="q" value="{{ q }}" placeholder="Buscar…">
  <button class="btn">Buscar</button>
</form>

<div class="table-responsive bg-white shadow rounded-3">
  <table class="table table-striped table-hover table-sm align-middle">

    {% if view.crud_config.model_name == 'historialequipos' %}
      <thead>
        <tr>
          <th><a href="?q={{ q }}&o=equipo__id_equipo">ID Equipo</a></th>
          <th><a href="?q={{ q }}&o=etiqueta">Etiqueta</a></th>
          <th><a href="?q={{ q }}&o=equipo">Equipo</a></th>
          <th><a href="?q={{ q }}&o=fecha">Fecha</a></th>
          <th><a href="?q={{ q }}&o=responsable_anterior_fk">Responsable Anterior</a></th>
          <th><a href="?q={{ q }}&o=estado_anterior">Estado Anterior</a></th>
          <th><a href="?q={{ q }}&o=estado_nuevo">Estado Nuevo</a></th>
          <th><a href="?q={{ q }}&o=responsable_actual">Responsable Actual</a></th>
          <th><a href="?q={{ q }}&o=empresa">Empresa</a></th>
          <th><a href="?q={{ q }}&o=departamento">Departamento</a></th>
          <th><a href="?q={{ q }}&o=usuario">Usuario</a></th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
          <tr>
            <td>{{ item.equipo.id_equipo|default:"—" }}</td>
            <td>{{ item.etiqueta|default:"—" }}</td>
            <td>{{ item.equipo|default:"—" }}</td>
            <td>{{ item.fecha|date:"d-m-Y H:i"|default:"—" }}</td>
            <td>{% firstof item.responsable_anterior_fk item.responsable_anterior "Nuevo" %}</td>
            <td>{{ item.estado_anterior|default:"—" }}</td>
            <td>{{ item.estado_nuevo|default:"—" }}</td>
            <td>{{ item.responsable_actual|default:"—" }}</td>
            <td>{{ item.empresa|default:"—" }}</td>
            <td>{{ item.departamento|default:"—" }}</td>
            <td>{{ item.usuario|default:"—" }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="11" class="text-center">No hay registros.</td></tr>
        {% endfor %}
      </tbody>

    {% else %}
      <thead>
        <tr>
          {% for col in view.crud_config.list_display %}
            <th><a href="?q={{ q }}&o={{ col }}">{{ col|title }}</a></th>
          {% endfor %}
          <th class="text-right">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
          <tr>
            {% for col in view.crud_config.list_display %}
              <td>{{ item|attr:col }}</td>
            {% endfor %}
            <td class="text-right">
              {% if view.crud_config.slug == 'historial_equipos' %}
              {% elif view.crud_config.model_name == 'equipo' %}
                <a class="btn btn-xs" href="{% url 'productos:equipos_update' item.id_equipo %}">Editar</a>
                {% if item.qr_code %}
                  <a class="btn btn-xs btn-success" href="{% url 'productos:equipos_qr' item.id_equipo %}">Ver QR</a>
                {% else %}
                  <a class="btn btn-xs btn-warning" href="{% url 'productos:equipos_update' item.id_equipo %}">Completar QR</a>
                {% endif %}
                <a class="btn btn-xs btn-info" href="{% url 'productos:equipo_historial_list' item.id_equipo %}">Historial</a>
                <a class="btn btn-xs btn-error" href="{% url 'productos:equipos_delete' item.id_equipo %}">Eliminar</a>
              {% else %}
                <a class="btn btn-xs" href="{% url 'productos:'|add:view.crud_config.slug|add:'_update' item.pk %}">Editar</a>
                <a class="btn btn-xs btn-error" href="{% url 'productos:'|add:view.crud_config.slug|add:'_delete' item.pk %}">Eliminar</a>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="{{ view.crud_config.list_display|length|add:1 }}" class="text-center">No hay registros.</td>
          </tr>
        {% endfor %}
      </tbody>
    {% endif %}

  </table>
</div>

<div class="join mt-4">
  {% if page_obj.has_previous %}
    <a class="join-item btn" href="?q={{ q }}&page=1">«</a>
    <a class="join-item btn" href="?q={{ q }}&page={{ page_obj.previous_page_number }}">Prev</a>
  {% endif %}
  <button class="join-item btn">
    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
  </button>
  {% if page_obj.has_next %}
    <a class="join-item btn" href="?q={{ q }}&page={{ page_obj.next_page_number }}">Next</a>
    <a class="join-item btn" href="?q={{ q }}&page={{ page_obj.paginator.num_pages }}">»</a>
  {% endif %}
</div>

<script>
function updateDateTime() {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit', 
        hour12: false 
    };
    document.getElementById('current_datetime').textContent =
        now.toLocaleString('es-CL', options);
}
setInterval(updateDateTime, 1000);
updateDateTime();
</script>
<style>
  td.text-right a.btn {
    display: inline-flex !important;
    margin: 0 2px;
  }
  td.text-right {
    white-space: nowrap;
  }
</style>

{% endblock %}
